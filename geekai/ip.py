import networkx as nx
import os
import pandas as pd
from domain import checkip,processDomain,psl
G=nx.read_adjlist("dga.txt")
pslSet = set(G.nodes)
phase1 = 'D:/ai/geek/phase1/trace2_test'
phase1 = '/home/OpenCode/malware/trace2_test'

basedir = phase1

ipfile = os.path.join(basedir,'fqdn_ip.csv')
fqdn_ip = pd.read_csv(ipfile)
fqdn_ip['domain'] = processDomain(fqdn_ip['site'])
fqdn_ip['psl'] = fqdn_ip.domain.map(lambda x:psl.get_public_suffix(x))
df = fqdn_ip[fqdn_ip.psl.map(lambda x: x in pslSet)]
df = df.groupby(['sha1','ip','psl'],as_index=False).count()
df = df[['sha1','ip','psl']]
df.to_csv('sha2ip.csv',index=False)
    